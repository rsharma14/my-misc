<!DOCTYPE html>
<html>

<head>
  <title>Video Player</title>
  <style>
    #video-player {
      width: 100%;
      height: 400px;
    }

    table {
      width: 100%;
    }

    .center {
      text-align: center;
    }

    #clipSeg {
      height: 400px;
      overflow-y: scroll;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      font-size: 75%;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      background-color: #000;
      color: #fff;
      border-radius: 1rem;
    }

    .timeField {
      width: 30px;
    }

    .segBtn {
      height: 24px;
      width: 24px;
      padding: 0px;
    }

    .bkt {
      font-weight: bold;
      font-size: 25px;
    }
  </style>
</head>
<title>My Video Clips Cutter</title>

<body>


  <h3 style="text-align: center;background-color: aquamarine;">Video Clips Cutter</h3>
  <table>
    <tbody>
      <tr>
        <td style="width: 70%;" class="center">
          <div>
            <span class="badge">1</span><strong> Upload Video: </strong>
            <input type="file" id="video-upload" accept="video/*">
            <button id="reset-button">Reset</button>
          </div><br>
          <div>
            <video id="video-player" controls></video>
          </div>

        </td>
        <td style="width: 30%;" class="center">
          <h3>Clip Segments</h3>
          <div id="clipSeg"></div>
        </td>
      </tr>
      <tr>
        <td class="center">
          <div>
            <div style="display: flex; justify-content: center; align-items: center;">
              <div style="display: flex; align-items: center;">
                <span class="badge">2</span>
              <button id="start-button" title="Start Clip"><span class="bkt">[</span></button>&nbsp;
              <input id="hours_0" type="number" min="0" max="99" value="00" onchange="updateTime(this,0)"
                class="timeField">
              <span>:</span>
              <input id="minutes_0" type="number" min="0" max="59" value="00" onchange="updateTime(this,0)"
                class="timeField">
              <span>:</span>
              <input id="seconds_0" type="number" min="0" max="59" value="00" onchange="updateTime(this,0)"
                class="timeField">
              </div>
              <span><strong>&nbsp;--&nbsp;</strong></span>
              <div style="display: flex; align-items: center;">

              <input id="hours_1" type="number" min="0" max="99" value="00" onchange="updateTime(this,1)"
                class="timeField">
              <span>:</span>
              <input id="minutes_1" type="number" min="0" max="59" value="00" onchange="updateTime(this,1)"
                class="timeField">
              <span>:</span>
              <input id="seconds_1" type="number" min="0" max="59" value="00" onchange="updateTime(this,1)"
                class="timeField">
                &nbsp;<button id="end-button" title="End Clip"><span class="bkt">]</span></button>
              <span class="badge">3</span>&nbsp;&nbsp;
            </div>
            <div style="display: flex; align-items: center;">
              <button id="add-button">Add Clip</button><span class="badge">4</span>
            </div>
          </div>
          </div>
        </td>
        <td class="center">
          <span class="badge">5</span><button id="save-clips">Save Clips</button>
        </td>
      </tr>
    </tbody>
  </table>
  <div id="savedClipTimes"></div>


  <script>
    function padWithZero(number) {
      return number.toString().padStart(2, '0');
    }

    function updateTime(inputElement, id) {
      var inputValue = parseInt(inputElement.value, 10);

      if (inputValue < 10) {
        inputElement.value = padWithZero(inputValue);
      }

      var hours = padWithZero(document.getElementById('hours_' + id).value);
      var minutes = padWithZero(document.getElementById('minutes_' + id).value);
      var seconds = padWithZero(document.getElementById('seconds_' + id).value);

      var formattedTime = hours + ':' + minutes + ':' + seconds;
      if (id == 0) {
        startTime_ = formattedTime;
        startTimeSec_ = convertTimeToSeconds(formattedTime);
      } else {
        endTime_ = formattedTime;
        endTimeSec_ = convertTimeToSeconds(formattedTime);
      }
      videoPlayer.currentTime = convertTimeToSeconds(formattedTime);
    }
    var videoPlayer = document.getElementById('video-player');
    var startButton = document.getElementById('start-button');
    var endButton = document.getElementById('end-button');
    var addButton = document.getElementById('add-button');
    var clipSeg = document.getElementById('clipSeg');
    var saveClips = document.getElementById('save-clips');
    var reset = document.getElementById('reset-button');

    var clips = {};
    var idx = 0;
    var startTime_, endTime_;
    var pstartTime, pendTime;
    var startTimeSec_, endTimeSec_, SegStartFlag = false;
    var currentTargetInSeg;
    var seekTime = 5;


    //videoPlayer.addEventListener("loadeddata",()=>{});

    document.getElementById('video-upload').addEventListener('change', function (e) {
      var file = e.target.files[0];
      var videoURL = URL.createObjectURL(file);
      videoPlayer.src = videoURL;
      document.getElementById("video-upload").disabled = true;
    });
    videoPlayer.addEventListener('keydown', function (event) {
      if (event.keyCode === 37) { // Left arrow key
        event.preventDefault();
        videoPlayer.currentTime -= seekTime; // Skip back 2 seconds
      } else if (event.keyCode === 39) { // Right arrow key
        event.preventDefault();
        videoPlayer.currentTime += seekTime; // Skip forward 2 seconds
      }
    });

    videoPlayer.addEventListener("timeupdate", () => {
      if (SegStartFlag && videoPlayer.currentTime >= endTimeSec_) {
        videoPlayer.pause();
        SegStartFlag = false;
        currentTargetInSeg.innerHTML = "&#9658;";

      }

    });
    startButton.addEventListener('click', function () {

      startTime_ = getFormattedTime(videoPlayer.currentTime);
      startTimeSec_ = videoPlayer.currentTime;
      endTime_ = undefined;
      setHMS(0, startTime_);

    });
    endButton.addEventListener('click', function () {
      if (startTime_) {
        endTime_ = getFormattedTime(videoPlayer.currentTime);
        endTimeSec_ = videoPlayer.currentTime;
        setHMS(1, endTime_);
      }

    });

    addButton.addEventListener('click', function () {
      if ((!startTime_ || !endTime_) || (startTime_ == endTime_) || (startTimeSec_ > endTimeSec_) || startTime_ == pstartTime && endTime_ == pendTime)
        return;
      pstartTime = startTime_;
      pendTime = endTime_;
      clips[idx++] = { startTime: startTime_, endTime: endTime_ };
      addInSegs();
    });
    clipSeg.addEventListener('click', function () {
      var target = event.target;

      if (target && target.id?.startsWith('play_')) {
        let targetId = target.id.split("_")[1];

        if (target.classList.contains("active")) {
          document.querySelectorAll("[id^='play_']").forEach(a => {
            a.classList.remove("active");
          });
        } else {
          document.querySelectorAll("[id^='play_']").forEach(a => {
            a.classList.remove("active");
          });
          target.classList.add("active");
          videoPlayer.pause();//pause for old running one
        }
        document.querySelectorAll("[id^='seg_']").forEach(a => {
          a.style.backgroundColor = null;
        });
        document.querySelector(`#seg_${targetId}`).style.backgroundColor = '#abedad';

        document.querySelectorAll("[id^='play_']").forEach(a => {
          a.innerHTML = "&#9658;";
        });
        //target.innerHTML = "&#10074;&#10074;"

        currentTargetInSeg = target;
        playVideo(target.id.split("_")[1], target);

      } else if (target && target.id?.startsWith('cancel_')) {
        delete clips[target.id.split("_")[1]];
        addInSegs();

      }
    });
    saveClips.addEventListener('click', function () {
      console.log(clips);
      let arr = [];
      for (let i in clips) {
        arr.push([clips[i].startTime, clips[i].endTime]);
      }
      document.querySelector("#savedClipTimes").innerHTML = "<div id='copyTimes'>" + JSON.stringify(arr) + "</div>";
      copyTimes();
    });
    reset.addEventListener('click', function () {
      window.location.reload();
    });

    function addInSegs() {
      clipSeg.innerHTML = "";
      clipSeg.insertAdjacentHTML("beforeend", "<table><tbody>");
      let tag = "";
      Object.keys(clips).forEach(id => {
        tag += "<tr><td id=seg_" + id + ">";
        tag += "<span id=clip_" + id + ">" + clips[id].startTime + " - " + clips[id].endTime + " [" + calculateDuration(clips[id].startTime, clips[id].endTime) + "]</span>"
        tag += " <button class='segBtn' style='color:green;' id=play_" + id + ">&#9654;</button>";
        tag += " <button class='segBtn' style='color:red;' id=cancel_" + id + ">&#10060;</button>";
        tag += "</td></tr>";
      });
      clipSeg.insertAdjacentHTML("beforeend", "<table><tbody>" + tag + "<table><tbody>");


    }
    function calculateDuration(startT, endT) {
      let inSec = convertTimeToSeconds(endT) - convertTimeToSeconds(startT);
      return getFormattedTime(inSec);

    }
    function setHMS(id, time) {
      document.getElementById('hours_' + id).value = time.split(":")[0];
      document.getElementById('minutes_' + id).value = time.split(":")[1];
      document.getElementById('seconds_' + id).value = time.split(":")[2];

    }
    function playVideo(clipId, target) {
      const st = convertTimeToSeconds(clips[clipId]['startTime']);
      const et = convertTimeToSeconds(clips[clipId]['endTime']);
      startTimeSec_ = st;
      endTimeSec_ = et;

      if (st > et) {
        alert("Start time>End time ");
        return;
      }

      if (videoPlayer.paused) {
        videoPlayer.currentTime = startTimeSec_;
        videoPlayer.play();
        target.innerHTML = "&#10074;&#10074;";
        SegStartFlag = true;
      } else {
        videoPlayer.pause();
        target.innerHTML = "&#9658;";
        SegStartFlag = false;


      }
      console.log(st + ":" + et)

    }

    function getFormattedTime(playTime) {
      var date = new Date(null);
      date.setSeconds(playTime);
      var timeString = date.toISOString().substr(11, 8); // Extracts HH:MM:SS from the ISO string

      return timeString;
    }
    function convertTimeToSeconds(timeString) {
      const [hours, minutes, seconds] = timeString.split(":");

      const hoursNumber = parseInt(hours, 10);
      const minutesNumber = parseInt(minutes, 10);
      const secondsNumber = parseInt(seconds, 10);

      return (hoursNumber * 3600 + minutesNumber * 60 + secondsNumber);

    }
    function copyTimes() {
      if (document.selection) {
        var range = document.body.createTextRange();
        range.moveToElementText(document.getElementById("copyTimes"));
        range.select();
      } else if (window.getSelection) {
        var range = document.createRange();
        range.selectNode(document.getElementById("copyTimes"));
        console.log(range)
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
      }
    }


  </script>
</body>

</html>