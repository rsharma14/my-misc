<!DOCTYPE HTML>
<html lang="en">

<head>
    <!-- when using the mode "code", it's important to specify charset utf-8 -->
    <meta charset="utf-8">

    <link href="json.css" rel="stylesheet" type="text/css">
    <link href="jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="jsoneditor.min.js"></script>
    <script src="jsonpath.js"></script>
    <style>
        #container {
            width: 600px;
            height: 500px;
        }

        #suggestionBox {
            display: flex;
            align-items: center;
            padding-bottom: 4px;
        }

        #suggestions {
            max-width: 670px;
            overflow-y: scroll;
            max-height: 216px;
            width: auto;
            margin-bottom: 5px;
            cursor: pointer;
            position: absolute;
            z-index: 111;
            background: #e3e0db;

        }

        #suggestions div {
            padding: 5px 10px 5px 10px;
        }

        #suggestions div:hover {
            background-color: lightblue;

        }

        #jsoneditor {
            width: 100%;
            height: 100%;
        }

        #queryBar {
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="container">
        <div id="suggestionBox">
            <textarea id="queryBar" name="w3review" rows="2" cols="50"
                placeholder="Enter your query to filter data"></textarea>
            <button type="button" id="queryBtn">Search</button>
        </div>
        <div id="suggestions"></div>

        <div id="jsoneditor"></div>
    </div>
    <script>
        var json = { "firstName": "John", "lastName": "doe", "age": 26, "address": { "streetAddress": "naist street", "city": "Nara", "postalCode": "630-0192" }, "phoneNumbers": [{ "type": "iPhone", "number": "0123-4567-8888" }, { "type": "home", "number": "0123-4567-8910" }] };
        var objKeys = new Set();
        const container = document.getElementById("jsoneditor");
        const options = {
            modes: ['text', 'code', 'tree', 'form', 'view'],
            mode: 'code',
        };
        options.onChange = (a, b, c) => {
            //if (isJSON(editor.getText())) {}
            setTimeout(() => {
                if (!isJSON(editor.getText())) return;
                //editor.set(json = editor.get());
                json = editor.get();;
                objKeys = new Set();
                iterate(json, '$');
            }, 500);


        }
        options.onModeChange = (newMode, oldMode) => {
            console.log({ newMode, oldMode });
        }
        const editor = new JSONEditor(container, options)
        document.querySelector(".jsoneditor-poweredBy")?.remove();
        editor.set(undefined);
        //iterate(json, '$');
        function iterate(obj, stack) {
            for (var property in obj) {
                if (obj.hasOwnProperty(property)) {
                    if (typeof obj[property] == "object") {
                        iterate(obj[property], (stack + (isNumber(property) ? "[*]" : '.' + property)));
                    } else {
                        objKeys.add(stack + "." + property);
                    }
                }
            }
            if (stack && !obj)
                objKeys.add(stack); //null/undefined value keys

        }
        document.querySelector("#queryBar").addEventListener("focusin", () => {
            //document.querySelector("#queryBar").select();
        });

        document.querySelector("#queryBar").addEventListener("input", () => {
            let input = document.querySelector("#queryBar").value;
            if (!input) {
                editor.set(json);
                return;
            }
            document.querySelector("#suggestions").innerHTML = filterObjKeys(input);
        });

        document.querySelector("#queryBtn").addEventListener("click", () => {
            searchInJSON();
        });
        queryBar.addEventListener("keydown", (event) => {

            if (event.keyCode === 13) {
                event.preventDefault();
                searchInJSON();
            }

        });

        document.addEventListener("click", () => {
            const div = document.getElementById("suggestions");
            if (!div.contains(event.target)) {
                document.querySelector("#suggestions").innerHTML = '';
            }
        });

        function searchInJSON() {
            let q = document.querySelector("#queryBar").value
            document.querySelector("#suggestions").innerHTML = '';
            if (!q)
                return editor.set(json);

            editor.set(jsonPath(json, q));
        }
        function filterObjKeys(key) {
            let ret = "";
            objKeys.forEach((o) => {
                if (o.toLowerCase().indexOf(key.toLowerCase()) > -1)
                    ret += `<div class="suggestion" onclick=selectSuggestion(this)>${o}</div>`;
            });
            return ret;
        }
        function selectSuggestion(t) {
            document.querySelector("#queryBar").value = t.innerText?.trim();
            document.querySelector("#suggestions").innerHTML = '';
            document.querySelector("#queryBar").focus();
        }
        function isJSON(jsonStr) {
            try {
                JSON.parse(jsonStr);
                console.log("valid json");
                return true;
            } catch (e) {
                console.log("not valid json");
                return false;
            }
        }
        function isNumber(str) {
            return !isNaN(parseFloat(str)) && str.trim() !== "";
        }


        //editor.set(json);
    </script>
</body>

</html>